<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order Status - Chuyzzz</title>
  <link rel="stylesheet" href="assets/css/order-status.css" />
  <script>
    if (!localStorage.getItem("loggedUser")) {
      window.location.href = "login.html";
    }
  </script>
</head>

<body class="night-bg">
  <main class="status-container">
    <h1>Order Status</h1>

    <p>Order #: <strong id="os-number">--</strong></p>
    <p>Status: <strong id="os-status" class="status-badge">--</strong></p>

    <div class="progress-bar" id="progress-bar">
      <div class="progress-step" data-step="Pending">Received</div>
      <div class="progress-step" data-step="Processing">Processing</div>
      <div class="progress-step" data-step="Out for Delivery">Out for Delivery</div>
      <div class="progress-step" data-step="Delivered">Delivered</div>
      <div class="progress-line" id="progress-line"></div>
    </div>

    <div id="os-items"></div>

    <div class="status-actions">
      <a href="shop.html" class="btn">Back to Shop</a>
      <button id="mark-delivered" class="btn">Mark as Delivered</button>
    </div>
  </main>

  <script src="assets/js/script.js"></script>

  <script>
    // Load last order or create one for demo
    let last = JSON.parse(localStorage.getItem('lastOrder') || 'null');
    if (!last) {
      last = {
        orderNumber: 'CHZ' + Math.floor(Math.random()*10000),
        status: 'Pending',
        items: [
          {name: 'Midnight Caramel Chips', quantity: 2, price: 120},
          {name: 'Choco Shake', quantity: 1, price: 80}
        ]
      };
      localStorage.setItem('lastOrder', JSON.stringify(last));
    }

    const statusEl = document.getElementById('os-status');
    const itemsEl = document.getElementById('os-items');
    const steps = document.querySelectorAll('.progress-step');
    const line = document.getElementById('progress-line');

    // Display order number
    document.getElementById('os-number').textContent = last.orderNumber;

    // Display items
    itemsEl.innerHTML = '';
    last.items.forEach(it => {
      const p = document.createElement('p');
      p.textContent = `${it.name} x${it.quantity} — ₱${it.price}`;
      itemsEl.appendChild(p);
    });

    // Status sequence
    const sequence = ['Pending', 'Processing', 'Out for Delivery', 'Delivered'];
    let currentIndex = sequence.indexOf(last.status);

    function updateProgress() {
      const currentStatus = sequence[currentIndex];
      statusEl.textContent = currentStatus;
      statusEl.className = 'status-badge ' + currentStatus.toLowerCase().replace(/ /g, '-');

      steps.forEach((step, idx) => {
        step.classList.toggle('active', idx <= currentIndex);
      });

      line.style.width = `${currentIndex/(steps.length-1)*100}%`;
      last.status = currentStatus;
      localStorage.setItem('lastOrder', JSON.stringify(last));

      if (currentIndex < sequence.length - 1) {
        currentIndex++;
        setTimeout(updateProgress, 3000); // 3 seconds per stage
      }
    }

    updateProgress(); // Start animation

    // Mark as Delivered manually
    document.getElementById("mark-delivered")?.addEventListener("click", () => {
      last.status = "Delivered";
      localStorage.setItem("lastOrder", JSON.stringify(last));
      location.reload();
    });
  </script>
</body>
</html>
